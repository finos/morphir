name: CI

on:
  push:
    branches:
      - main
      - setup/**
  pull_request:
    branches:
      - main

env:
  CARGO_TERM_COLOR: always

jobs:
  # morphir-live: web UI application (depends on dioxus)
  morphir-live:
    name: morphir-live
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install mise
        uses: jdx/mise-action@v2

      - name: Initialize environment
        run: mise run init -- --ci

      - name: Add Rust components
        run: rustup component add rustfmt clippy

      - name: Install GTK dependencies (for desktop build)
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev libxdo-dev

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: ". -> target"
          key: morphir-live

      - name: Check formatting
        run: cargo fmt --package morphir-live --check

      - name: Run clippy
        run: cargo clippy --package morphir-live --all-targets -- -D warnings

      - name: Run tests
        run: cargo test --package morphir-live

      - name: Build (web)
        run: cargo build --release --package morphir-live

      - name: Build (desktop)
        run: cargo build --release --package morphir-live --features desktop

  # morphir: CLI tool (depends on extism via morphir-daemon)
  # Uses separate dependency resolution to avoid conflict with dioxus-desktop
  morphir-cli:
    name: morphir CLI
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install mise
        uses: jdx/mise-action@v2

      - name: Initialize environment
        run: mise run init -- --ci

      - name: Add Rust components
        run: rustup component add rustfmt clippy

      # Generate fresh lockfile without dioxus-desktop to avoid toml_datetime conflict
      - name: Regenerate lockfile for CLI
        run: |
          # Remove morphir-live from workspace temporarily to avoid dependency conflict
          sed -i 's/members = \["crates\/\*"\]/members = ["crates\/morphir"]/' Cargo.toml
          sed -i 's/default-members = \["crates\/morphir-live", "crates\/morphir"\]/default-members = ["crates\/morphir"]/' Cargo.toml
          rm Cargo.lock
          cargo generate-lockfile
          # Update extism to latest compatible version
          cargo update -p extism

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: ". -> target"
          key: morphir-cli

      - name: Check formatting
        run: cargo fmt --package morphir --check

      - name: Run clippy
        run: cargo clippy --package morphir --all-targets -- -D warnings

      - name: Run tests
        run: cargo test --package morphir

      - name: Build
        run: cargo build --release --package morphir

  check:
    name: All Checks
    runs-on: ubuntu-latest
    needs: [morphir-live, morphir-cli]
    steps:
      - name: All checks passed
        run: echo "All checks passed!"

  # TODO: Add WASM build once dioxus-cli workspace issue is resolved
