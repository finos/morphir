# Morphir Development Tools Configuration
# This project contains:
# - Rust-based tooling (crates/morphir-live)
# - Docusaurus website (website/)

[settings]
experimental = true

[tools]
# Core tools
rust = "1.93.0"
python = "3.14.2"

# JavaScript runtimes for website and tooling
node = "24.13.0"
bun = "1.3.8"
"npm:morphir-elm" = "2.100.0"

# Rust tools
"cargo:cargo-binstall" = "latest"
"cargo:dioxus-cli" = "latest"       # Provides dx command
"aqua:WebAssembly/binaryen" = "125" # Provides wasm-opt

# JSON Schema CLI (https://github.com/sourcemeta/jsonschema)
jsonschema = "latest"

# ===== Formatting Tasks =====
[tasks.fmt]
description = "Format all code"
depends = ["fmt:rust", "fmt:schema"]

[tasks."fmt:rust"]
description = "Format Rust code"
run = "cargo fmt --all"

[tasks."fmt:schema"]
description = "Format JSON Schema files"
run = "jsonschema fmt website/static/schemas/"

[tasks.fmt-check]
description = "Check all formatting"
depends = ["fmt-check:rust", "fmt-check:schema"]

[tasks."fmt-check:rust"]
description = "Check Rust code formatting"
run = "cargo fmt --all --check"

[tasks."fmt-check:schema"]
description = "Check JSON Schema formatting"
run = "jsonschema fmt website/static/schemas/ --check"

# ===== Linting Tasks =====
[tasks.lint]
description = "Run all linters"
depends = ["lint:rust", "lint:schema"]

[tasks."lint:rust"]
description = "Run Clippy linter"
run = "cargo clippy --all-targets --all-features -- -D warnings"

[tasks."lint:schema"]
description = "Lint JSON Schema files"
run = "jsonschema lint website/static/schemas/*.yaml website/static/schemas/*.json"

# ===== Validation Tasks =====
[tasks."schema:validate"]
description = "Validate schemas against metaschema"
run = "jsonschema metaschema website/static/schemas/*.yaml"

[tasks.check]
description = "Run all checks"
depends = [
    "fmt-check",
    "lint",
    "examples:validate",
    "fixtures:validate",
    "schema:validate",
]

# ===== Testing Tasks =====
[tasks.test]
description = "Run tests"
run = "cargo test --all-features --workspace"

[tasks.build]
description = "Build release"
run = "cargo build --release --workspace"

[tasks.dev]
description = "Run morphir-live in development mode"
run = "dx serve"
dir = "crates/morphir-live"

[tasks.clean]
description = "Clean build artifacts"
run = "cargo clean"

# ===== Website Tasks =====
[tasks."website:install"]
description = "Install website dependencies"
run = "npm install"
dir = "website"

[tasks."website:build-schemas"]
description = "Generate JSON schemas from YAML sources"
run = "npm run build:schemas"
dir = "website"
depends = ["website:install"]

[tasks."website:build-worker"]
description = "Build the validation worker (bundles Ajv)"
run = "npm run build:worker"
dir = "website"
depends = ["website:install"]

[tasks."website:build"]
description = "Build the website for production"
run = "npm run build"
dir = "website"
depends = ["website:build-schemas", "website:build-worker"]

[tasks."website:dev"]
description = "Start website development server"
run = "npm run start"
dir = "website"
depends = ["website:build-schemas", "website:build-worker"]

[tasks."website:typecheck"]
description = "Run TypeScript type checking on website"
run = "npm run typecheck"
dir = "website"
depends = ["website:install"]
